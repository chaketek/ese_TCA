# MoTeC .CC9 ファイルフォーマット解析ドキュメント

## 解析対象ファイル
| ファイル名 | CAN ID | ファイルサイズ |
|-----------|--------|---------------|
| LTC #1 (CAN ID 460).CC9 | 0x460 (1120) | 9344 バイト |
| LTC #4 (CAN ID 463).CC9 | 0x463 (1123) | 9344 バイト |
| LTC #9 (CAN ID 468).CC9 | 0x468 (1128) | 9344 バイト |
| LTC #11 (CAN ID 46A).CC9 | 0x46A (1130) | 9344 バイト |

- **対応デバイス**: LTC (Lambda-to-CAN) ワイドバンドコントローラ
- **注意**: ファイル名の CAN ID は**16進数表記** (例: 460 = 0x460 = 1120 decimal)

---

## 1. ファイルヘッダー構造

### 1.1 マジックナンバー / ファイル識別子
| オフセット | 長さ | 値 (Hex) | 値 (ASCII) | 説明 |
|-----------|------|----------|------------|------|
| 0x0000 | 8 | 43 4F 4D 53 45 54 56 00 | `COMSETV\0` | ファイルタイプ識別子 |

### 1.2 ファイル説明
| オフセット | 長さ | 値 (ASCII) | 説明 |
|-----------|------|------------|------|
| 0x0010 | 24 | `Communications setup file` | ファイル種別説明 |

---

## 2. セクション構造

ファイルは複数のセクションで構成されており、各セクションは8バイトの識別子で始まります。

### 2.1 確認されたセクション

| オフセット | 識別子 | 説明 |
|-----------|--------|------|
| 0x0100 | `CANI___` | CAN入力定義セクション |
| 0x2160 | `USERCHN` | ユーザーチャンネル定義 |
| 0x2260 | `CHANLST` | チャンネルリスト |
| 0x2360 | `CFGENUM` | 設定列挙テーブル |

---

## 3. ★ CAN ID 格納位置 (確定) ★

### 3.1 主要 CAN ID 格納位置

**⚠️ 重要な発見: CAN IDは オフセット 0x20C4 に格納されています！**

| オフセット | 長さ | フォーマット | 説明 |
|-----------|------|-------------|------|
| **0x20C4** | 2 | Little Endian (16-bit) | **実際の CAN ID 値** |

#### 比較検証結果
| ファイル | オフセット 0x20C4-0x20C5 | 解釈 (LE) | CAN ID |
|----------|-------------------------|-----------|--------|
| LTC #1 | `60 04` | 0x0460 | **0x460** ✓ |
| LTC #4 | `63 04` | 0x0463 | **0x463** ✓ |
| LTC #9 | `68 04` | 0x0468 | **0x468** ✓ |
| LTC #11 | `6A 04` | 0x046A | **0x46A** ✓ |

### 3.2 CAN ID 周辺構造体 (オフセット 0x20C0)
```
Offset  +0  +1  +2  +3  +4  +5  +6  +7  +8  +9  +A  +B
0x20C0: 00  00  00  00  [CAN_ID_LO] [CAN_ID_HI] [FIELD1] [FIELD2] [FLAG]
```

| フィールド | オフセット | 長さ | 説明 |
|-----------|-----------|------|------|
| Reserved | 0x20C0 | 4 | 常に 0x00000000 |
| CAN ID | 0x20C4 | 2 | Little Endian 16-bit CAN ID |
| Field1 | 0x20C6 | 2 | 不明 (LTC #1 のみ 0x1F7D、他は 0x0000) |
| Field2 | 0x20C8 | 2 | 不明 (LTC #1 のみ 0x0013、他は 0x0000) |
| Flag | 0x20CA | 1 | 常に 0x01 |

### 3.3 デバイス名格納位置
| オフセット | 長さ | 説明 |
|-----------|------|------|
| 0x0115 | ~20 | デバイス名文字列 (NULL終端) |

#### 検出されたデバイス名
| ファイル | 0x0115からの文字列 |
|----------|-------------------|
| LTC #1 | `1 (CAN ID 460)` |
| LTC #4 | `4 (CAN ID 463)` |
| LTC #9 | `9 (CAN ID 468)` |
| LTC #11 | `11 (CAN ID 46A)` |

---

## 4. ★ パラメータID法則性 (確定) ★

### 4.1 CAN ID依存パラメータ

複数ファイル比較により、パラメータIDがCAN IDに基づいて変化することを確認しました。

#### Type A: CAN ID と同一差分を持つパラメータ
| オフセット | LTC #1 (0x460) | LTC #4 (0x463) | LTC #9 (0x468) | LTC #11 (0x46A) | 差分パターン |
|-----------|---------------|---------------|---------------|----------------|-------------|
| 0x01F6 | 0xDB | 0xDE | 0xE3 | 0xE5 | +3, +8, +10 ← CAN IDと同じ |
| 0x0232 | 0x5D | 0x60 | 0x65 | 0x67 | +3, +8, +10 ← CAN IDと同じ |

**法則**: `param_value = base_value + (CAN_ID - 0x460)`

#### Type B: CAN ID × 7 の差分を持つパラメータ
| オフセット | LTC #1 (0x460) | LTC #4 (0x463) | LTC #9 (0x468) | LTC #11 (0x46A) | 差分パターン |
|-----------|---------------|---------------|---------------|----------------|-------------|
| 0x0214 | 0xEB | 0x00 | 0x23 | 0x31 | +21, +56, +70 |
| 0x0250 | 0xEF | 0x04 | 0x27 | 0x35 | +21, +56, +70 |
| 0x026E | 0xF1 | 0x06 | 0x29 | 0x37 | +21, +56, +70 |
| 0x03D6 | 0xF0 | 0x05 | 0x28 | 0x36 | +21, +56, +70 |
| 0x03F4 | 0xEE | 0x03 | 0x26 | 0x34 | +21, +56, +70 |
| 0x0412 | 0xEC | 0x01 | 0x24 | 0x32 | +21, +56, +70 |
| 0x0430 | 0xED | 0x02 | 0x25 | 0x33 | +21, +56, +70 |

**法則検証**:
- CAN ID差分: +3, +8, +10
- パラメータ差分: +21, +56, +70
- 比率: 21÷3=7, 56÷8=7, 70÷10=7 → **7倍の関係**

**法則**: `param_value = base_value + (CAN_ID - 0x460) × 7`

### 4.2 パラメータIDの相互関係

0x01F6 と 0x0232 のパラメータIDには常に **0x7E (126)** の差があります：
```
0x01F6 - 0x0232 = 0xDB - 0x5D = 126 (全ファイルで同一)
```

これは MoTeC 内部のチャンネル定義テーブルのオフセットと推定されます。

---

## 5. チャンネルパラメータ定義

### 5.1 パラメータレコード構造 (推定)

オフセット0x01F6付近から、複数のパラメータレコードが存在します。
各レコードは約30バイトの固定長と推定されます。

| フィールド | オフセット | 長さ | 説明 |
|-----------|-----------|------|------|
| Channel ID | +0x00 | 2 | チャンネル識別子 (0x22DB等) |
| Parameter Index | +0x02 | 2 | パラメータインデックス |
| Start Position | +0x04 | 2 | ビット開始位置 |
| Width | +0x06 | 2 | ビット幅 |
| Data Mask | +0x08 | 2 | データマスク (0xFFFF等) |
| Multiplier | +0x0A | 2 | 乗算係数 |
| Divider | +0x0C | 2 | 除算係数 |
| Flags | +0x0E | 2 | フラグ (符号、バイトオーダー等) |

### 5.2 検出されたパラメータパターン

```
オフセット 0x01F6: DB 22 0A 00 01 00 02 00 FF FF 01 00 01 00 ...
オフセット 0x0210: EB 22 0B 00 03 00 02 00 FF FF 01 00 01 00 ...
オフセット 0x022A: 5D 23 0C 00 05 00 01 00 FF 00 0A 00 01 00 ...
オフセット 0x0244: EF 22 0D 00 06 00 01 00 FF 00 01 00 01 00 ...
オフセット 0x025E: F1 22 0E 00 07 00 01 00 FF 00 0A 00 01 00 ...
```

---

## 6. LTCデバイス CAN仕様との照合

### 6.1 LTC Message 1 (CAN ID = ベース + 0)
画像の仕様書より:

| Byte | Name | Scaling | CC9での推定マッピング |
|------|------|---------|----------------------|
| 0 | Compound ID = 0 | N/A | - |
| 1:2 | Lambda | Hi:Lo = x.xxxLa | Width=16, Mult=1, Div=1000, Offset=0 |
| 3:4 | Ipn | Hi:Lo = xxxx µA | Width=16 |
| 5 | LTC Internal Temp | xxx °C | Width=8 |
| 6 | Fault bits | Bitfield | Width=8 |
| 7 | Heater duty cycle | xxx% | Width=8, Mult=10 |

### 6.2 LTC Message 2 (CAN ID = ベース + 1)

| Byte | Name | Scaling |
|------|------|---------|
| 0 | Compound ID = 1 | N/A |
| 1 | Sensor State | Enum (0-10) |
| 2:3 | Battery Voltage | Hi:Lo = x.xxV |
| 4:5 | Ip (Raw pump cell current) | Hi:Lo = xxxx µA |
| 6:7 | Ri (Sensor cell impedance) | Hi:Lo = xxxx Ohms |

---

## 6. 画像1の設定との照合 (Lambda 1パラメータ)

添付画像1のMoTeC設定画面より:

| 設定項目 | 値 | CC9内での推定位置 |
|----------|-----|-------------------|
| Parameter | Lambda 1 | チャンネル名 |
| Start Position | 8 | Byte 1からスタート (ビット8) |
| Width | 16 | 2バイト (16ビット) |
| Byte Order | MS First | Big Endian |
| Type | Unsigned | 符号なし整数 |
| Multiplier | 1 | 乗算係数 |
| Divider | 1000 | 除算係数 |
| Offset | 0 | オフセット |

**計算式**: `Lambda = raw_value / 1000`

---

## 7. 既知のチャンネルID値

CC9ファイル内で確認されたチャンネルID (リトルエンディアン):

| Hex値 | 推定パラメータ |
|-------|---------------|
| 0x22DB | Lambda関連 |
| 0x22EB | Ipn (ポンプセル電流) |
| 0x235D | Temperature |
| 0x22EF | Fault bits |
| 0x22F1 | Heater duty |
| 0x22F0 | Compound ID |
| 0x22EE | Battery Voltage |
| 0x22EC | Ip (Raw) |
| 0x22ED | Ri (インピーダンス) |

---

## 8. ファイル構造サマリー

```
+------------------+
| COMSETV Header   | 0x0000 - 0x00FF (256 bytes)
+------------------+
| CANI___ Section  | 0x0100 - 0x01F5 (CAN設定ヘッダー)
|   - CAN ID       |
|   - 設定名       |
+------------------+
| Parameter Table  | 0x01F6 - 0x03CF (Message 1 パラメータ)
| (Message 1)      |
+------------------+
| Parameter Table  | 0x03D0 - 0x20xx (Message 2+ パラメータ)
| (Message 2+)     |
+------------------+
| Padding/Reserved | 多数のゼロパディング
+------------------+
| USERCHN Section  | 0x2160 (ユーザーチャンネル)
+------------------+
| CHANLST Section  | 0x2260 (チャンネルリスト)
+------------------+
| CFGENUM Section  | 0x2360 (設定列挙)
+------------------+
| Footer           | 0x2460 - EOF
+------------------+
```

---

## 9. CAN ID 460 (0x1CC) の意味

ファイル名「LTC #1 (CAN ID 460)」より:
- **CAN ID 460 (10進) = 0x1CC (16進)**
- CC9ファイル内では **0x2060** として格納 (リトルエンディアン表現または内部フォーマット)

LTCデバイスは通常、ベースCAN IDから複数のメッセージを送信:
- Message 1: CAN ID 460 (0x1CC)
- Message 2: CAN ID 461 (0x1CD)

---

## 10. 制限事項・今後の課題

1. **パラメータレコードの正確なフィールド境界**が未確定
2. **チャンネルIDのマスタテーブル**の場所が不明
3. **符号付き/符号なしの判定フラグ**の位置が未特定
4. **バイトオーダー (MS First/LS First) フラグ**の位置が未特定

---

## 11. 参考情報

### LTC Fault bits (Byte 6) 詳細
| Bit | 名称 | 備考 |
|-----|------|------|
| 0 | Heater short to Gnd | LTC4.9のみ |
| 1 | Heater short to VBatt | LTC4.9のみ |
| 2 | Heater open circuit | |
| 3 | Heater failed to heat | LTC4.9のみ |
| 4 | Sensor wire short | LTC4.9のみ |
| 5 | Internal fault | LTC4.9のみ |
| 6 | Sensor Control fault | LTC-NTKのみ |

### Sensor State (Message 2, Byte 1) 詳細
| 値 | 状態 |
|----|------|
| 0 | START |
| 1 | DIAGNOSTICS |
| 2 | PRE CAL |
| 3 | CALIBRATION |
| 4 | POST CAL |
| 5 | PAUSED |
| 6 | HEATING |
| 7 | RUNNING |
| 8 | COOLING |
| 9 | PUMP START |
| 10 | PUMP OFF |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026/02/01 | 初版作成 - バイナリ解析結果 |
